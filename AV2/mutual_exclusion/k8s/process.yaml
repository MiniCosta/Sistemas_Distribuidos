---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: process
  namespace: mutual-exclusion
  labels:
    app: process
spec:
  replicas: 4 # 4 processos competindo pela região crítica
  selector:
    matchLabels:
      app: process
  template:
    metadata:
      labels:
        app: process
    spec:
      containers:
        - name: process
          image: mutual-exclusion-process:latest
          imagePullPolicy: Never # Usar imagem local do Minikube
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: COORDINATOR_URL
              value: "http://coordinator:5000"
            - name: CS_DURATION
              value: "3" # Duração na região crítica (segundos)
            - name: INTERVAL_MIN
              value: "5" # Intervalo mínimo entre requisições
            - name: INTERVAL_MAX
              value: "15" # Intervalo máximo entre requisições
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: PROCESS_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name # Usar nome do pod como ID
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: process
  namespace: mutual-exclusion
  labels:
    app: process
spec:
  type: ClusterIP
  selector:
    app: process
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
      name: http
  clusterIP: None # Headless service para acesso direto aos pods
